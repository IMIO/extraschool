<?xml version="1.0" ?>
<odoo>
    <data>

        <template id="report_invoice_regroup_by_activity_by_child_by_day">
            <xpath expr="//head" position="inside">
                <link rel="stylesheet"
                      href="/extraschool/static/src/css/report_invoice_regroup_by_activity_by_child_by_day.css"/>
            </xpath>
            <div id="invoice_body">
                <h2>Détail des présences</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Activité</th>
                            <th>Date</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="invoice.get_infos_childs()" t-as="invoice_line">
                            <tr>
                                <td>
                                    <span
                                        t-esc="'%s - %s' % (invoice_line[0].childid.name, invoice_line[0].activity_occurrence_id.activityid.short_name)"/>
                                </td>
                                <td>
                                    <span
                                        t-esc="datetime.datetime.strptime(invoice_line[0].prestation_date, '%Y-%m-%d').date().strftime('%d-%m-%Y')"/>
                                </td>
                                <td class="amount">
                                    <span t-esc="'%.2f €' %  (invoice_line[3])"/>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </div>
        </template>

        <template id="report_invoice_regroup_by_activity_by_child_by_day_enter_exit"
                  inherit_id="report_invoice_regroup_by_activity_by_child_by_day" primary="True">
            <xpath expr="//th[1]" position="after">
                <th>Entrée</th>
                <th>Sortie</th>
            </xpath>
            <xpath expr="//td[1]" position="after">
                <td>
                    <span t-esc="invoice_line[1]"/>
                </td>
                <td>
                    <span t-esc="invoice_line[2]"/>
                </td>
            </xpath>
        </template>

        <template id="report_invoice_regroup_by_activity_by_child">
            <xpath expr="//head" position="inside">
                <link rel="stylesheet" href="/extraschool/static/src/css/report_invoice_regroup_by_activity_by_child.css"/>
            </xpath>
        	<div id="invoice_body">
        		<table>
        			<tr>
	        			<th>Activité</th>
	        			<th class="col_quantity">Quantité</th>
	        			<th>Total</th>
					</tr>
					<t t-set="saved_child_id" t-value="0"/>
					<t t-set="saved_activity" t-value="'******'"/>
					<t t-set="saved_description" t-value="'*****'"/>
					<t t-set="activity_count" t-value="0"/>
					<t t-set="activity_amount" t-value="0"/>
					<t t-set="activity_time" t-value="0"/>

	       			<t t-foreach="invoice.invoice_line_ids.sorted(key=lambda r: (('%s%s') % (r.childid.name,r.activity_occurrence_id.activityid.short_name)))" t-as="invoice_line">
	       				<t t-if="saved_child_id != invoice_line.childid or saved_activity != invoice_line.activity_occurrence_id.activityid.short_name">
	       					<t t-if="activity_count != 0">
		        				<tr>
			       					<td><span t-esc="'%s - %s %s' % (saved_child_id.name if len(saved_child_id) else '',saved_activity if saved_activity != False else '',saved_description if saved_description != False else '')" /></td>
			       					<td class="col_quantity amount"><span t-esc="activity_count" /></td>
			       					<td class="amount"><span t-esc="'%.2f €' %  (activity_amount)" /></td>
			       				</tr>
	       					</t>
	       					<t t-set="saved_child_id" t-value="invoice_line.childid"/>
	       					<t t-set="saved_activity" t-value="invoice_line.activity_occurrence_id.activityid.short_name"/>
	       					<t t-set="saved_description" t-value="invoice_line.description"/>
							<t t-set="activity_count" t-value="0"/>
							<t t-set="activity_amount" t-value="0"/>
							<t t-set="activity_time" t-value="0"/>
						</t>
	       				<t t-if="saved_activity == invoice_line.activity_occurrence_id.activityid.short_name">
							<t t-set="activity_count" t-value="activity_count + 1"/>
							<t t-set="activity_amount" t-value="activity_amount + invoice_line.total_price"/>
							<t t-set="activity_time" t-value="activity_time + invoice_line.duration"/>
						</t>
	        		</t>
   					<t t-if="activity_count != 0">
        				<tr>
	       					<td><span t-esc="'%s - %s %s' % (saved_child_id.name if len(saved_child_id) else '',saved_activity if saved_activity != False else '',saved_description if saved_description != False else '')" /></td>
	       					<td class="col_quantity amount"><span t-esc="activity_count" /></td>
	       					<td class="amount"><span t-esc="'%.2f €' %  (activity_amount)" /></td>
	       				</tr>
   					</t>

        		</table>
       		</div>
		</template>

<!--        <template id="report_invoice_regroup_by_activity_by_child">-->
<!--            <xpath expr="//head" position="inside">-->
<!--                <link rel="stylesheet"-->
<!--                      href="/extraschool/static/src/css/report_invoice_regroup_by_activity_by_child.css"/>-->
<!--            </xpath>-->
<!--            <xpath expr="//th[2]" position="replace">-->
<!--                <th class="col_quantity">Quantité</th>-->
<!--            </xpath>-->
<!--            <xpath expr="//td[2]" position="replace">-->
<!--                <td class="col_quantity amount">-->
<!--                    <span t-esc="activity_count"/>-->
<!--                </td>-->
<!--            </xpath>-->
<!--        </template>-->

        <template id="report_invoice_regroup_by_activity_by_child_no_quantity"
                  inherit_id="extraschool.report_invoice_regroup_by_activity_by_child" primary="True">

            <xpath expr="//div[@id='invoice_body']" position="before">
                <xpath expr="//head" position="inside">
                    <link rel="stylesheet"
                          href="/extraschool/static/src/css/report_invoice_regroup_by_activity_by_child_no_quantity.css"/>
                </xpath>
            </xpath>
        </template>

    </data>
</odoo>

