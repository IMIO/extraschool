<?xml version="1.0" ?>
<odoo>
    <data>

        <template id="invoice_report_layout_performance" inherit_id="report.layout" primary="True">
            <xpath expr="//body" position="attributes">
                <attribute t-translation="off" name="onload">subst(); pagination_hide();</attribute>
            </xpath>

            <xpath expr="//head" position="inside">
                <link rel="stylesheet" href="/extraschool/static/src/css/report_adresse_no_style.css"/>
            </xpath>

            <xpath expr="//html" position="attributes">
                <attribute name="t-att-data-report-margin-top">
                    docs[0].activitycategoryid[0].invoice_report_id.paper_format_id.margin_top
                </attribute>
                <attribute name="t-att-data-report-margin-bottom">
                    docs[0].activitycategoryid[0].invoice_report_id.paper_format_id.margin_bottom
                </attribute>
                <attribute name="t-att-data-report-margin-right">
                    docs[0].activitycategoryid[0].invoice_report_id.paper_format_id.margin_right
                </attribute>
                <attribute name="t-att-data-report-margin-left">
                    docs[0].activitycategoryid[0].invoice_report_id.paper_format_id.margin_left
                </attribute>
            </xpath>

            <xpath expr="//body" position="attributes">
                <attribute name="t-att-class">container</attribute>
            </xpath>

            <xpath expr="//body" position="inside">
                <div id="invoice">
                    <t t-foreach="docs" t-as="invoice">

                        <div class="header">
                        </div>

                        <div class="page">
                            <div class="aes_adresse">
                                <div id="aes_po_adresse" class="aes_adresse_block po">
                                    <span t-field="invoice.activitycategoryid[0].organising_power_id.po_name"/>
                                    <span t-field="invoice.activitycategoryid[0].organising_power_id.po_street"/>
                                    <span>
                                        <t t-esc="invoice.activitycategoryid[0].organising_power_id.po_zipcode"/>
                                        <t t-esc="invoice.activitycategoryid[0].organising_power_id.po_city"/>
                                    </span>
                                    <span t-field="invoice.activitycategoryid[0].organising_power_id.po_email"/>
                                    <span t-field="invoice.activitycategoryid[0].organising_power_id.po_tel"/>
                                    <span
                                        t-raw="invoice.activitycategoryid[0].organising_power_id.po_addresse_free_text"/>
                                </div>
                                <div id="aes_block_customer" class="aes_adresse_block customer">
                                    <span t-field="invoice.parentid.name"/>
                                    <span t-field="invoice.parentid.street"/>
                                    <span>
                                        <t t-esc="invoice.parentid.zipcode"/>
                                        <t t-esc="invoice.parentid.city"/>
                                    </span>
                                </div>
                            </div>

                            <div style="display: block;width: 100%;height: 1cm;clear: both;">
                            </div>

                            <div style="width: 100%;display: block;margin: 0cm 0cm 0cm 0cm;">
                                <div class="your_ref">
                                    <b>Notre référence :</b>
                                    <span t-field="invoice.name"/>
                                </div>
                                <div class="your_ref">
                                    <b>Facture numéro :</b>
                                    <span t-field="invoice.number"/>
                                </div>
                                <div class="invoice_period">
                                    <b>Période du :</b>
                                    <span t-field="invoice.biller_id.period_from"/>
                                    <b>au</b>
                                    <span t-field="invoice.biller_id.period_to"/>
                                </div>
                            </div>

                            <div id="invoice_body">
                                <table>
                                    <tr>
                                        <th>Activité</th>
                                        <th class="col_quantity">Quantité</th>
                                        <th>Total</th>
                                    </tr>
                                    <t t-set="saved_child_id" t-value="0"/>
                                    <t t-set="saved_activity" t-value="'******'"/>
                                    <t t-set="saved_description" t-value="'*****'"/>
                                    <t t-set="activity_count" t-value="0"/>
                                    <t t-set="activity_amount" t-value="0"/>
                                    <t t-set="activity_time" t-value="0"/>

                                    <t t-foreach="invoice.invoice_line_ids.sorted(key=lambda r: (('%s%s') % (r.childid.name,r.activity_occurrence_id.activityid.short_name)))"
                                       t-as="invoice_line">
                                        <t t-if="saved_child_id != invoice_line.childid or saved_activity != invoice_line.activity_occurrence_id.activityid.short_name">
                                            <t t-if="activity_count != 0">
                                                <tr>
                                                    <td>
                                                        <span
                                                            t-esc="'%s - %s %s' % (saved_child_id.name if len(saved_child_id) else '',saved_activity if saved_activity != False else '',saved_description if saved_description != False else '')"/>
                                                    </td>
                                                    <td class="col_quantity amount">
                                                        <span t-esc="activity_count"/>
                                                    </td>
                                                    <td class="amount">
                                                        <span t-esc="'%.2f €' %  (activity_amount)"/>
                                                    </td>
                                                </tr>
                                            </t>
                                            <t t-set="saved_child_id" t-value="invoice_line.childid"/>
                                            <t t-set="saved_activity"
                                               t-value="invoice_line.activity_occurrence_id.activityid.short_name"/>
                                            <t t-set="saved_description" t-value="invoice_line.description"/>
                                            <t t-set="activity_count" t-value="0"/>
                                            <t t-set="activity_amount" t-value="0"/>
                                            <t t-set="activity_time" t-value="0"/>
                                        </t>
                                        <t t-if="saved_activity == invoice_line.activity_occurrence_id.activityid.short_name">
                                            <t t-set="activity_count" t-value="activity_count + 1"/>
                                            <t t-set="activity_amount"
                                               t-value="activity_amount + invoice_line.total_price"/>
                                            <t t-set="activity_time" t-value="activity_time + invoice_line.duration"/>
                                        </t>
                                    </t>
                                    <t t-if="activity_count != 0">
                                        <tr>
                                            <td>
                                                <span
                                                    t-esc="'%s - %s %s' % (saved_child_id.name if len(saved_child_id) else '',saved_activity if saved_activity != False else '',saved_description if saved_description != False else '')"/>
                                            </td>
                                            <td class="col_quantity amount">
                                                <span t-esc="activity_count"/>
                                            </td>
                                            <td class="amount">
                                                <span t-esc="'%.2f €' %  (activity_amount)"/>
                                            </td>
                                        </tr>
                                    </t>

                                </table>
                            </div>

                            <div id="total_row">
                                <div id="total">
                                    <div class="amount" t-if="reminder_type == 'free'">
                                        <span class="zz_label">Total</span>
                                        <span class="amount">
                                            <t t-esc="'%.2f' %  (invoice.balance)"/>
                                            €
                                        </span>
                                    </div>
                                    <div class="amount" t-if="reminder_type == 'fix'">
                                        <span class="zz_label">Total</span>
                                        <span class="amount">
                                            <t t-esc="'%.2f' %  (invoice.balance - invoice.last_reminder_id.reminders_journal_item_id.reminder_type_id.fees_amount.fees)"/>
                                            €
                                        </span>
                                    </div>
                                    <div class="amount" t-if="received != 0">
                                        <span class="zz_label">Reçu</span>
                                        <span class="amount">
                                            <t t-esc="'%.2f' %  (invoice.amount_received)"/>
                                            €
                                        </span>
                                    </div>
                                    <div class="amount" t-if="reminder_type == 'fix'">
                                        <span class="zz_label">Frais de rappel</span>
                                        <span class="amount">
                                            <t t-esc="'%.2f' %  (invoice.last_reminder_id.reminders_journal_item_id.reminder_type_id.fees_amount.fees)"/>
                                            €
                                        </span>
                                    </div>
                                    <div class="amount to_pay" t-if="reminder_type == 'fix'">
                                        <span class="zz_label">Solde</span>
                                        <span class="amount">
                                            <t t-esc="'%.2f' %  (invoice.last_reminder_id.balance)"/>
                                            €
                                        </span>
                                    </div>
                                    <div class="amount to_pay" t-if="reminder_type == 'free'">
                                        <span class="zz_label">Solde</span>
                                        <span class="amount">
                                            <t t-esc="'%.2f' %  (invoice.last_reminder_id.balance)"/>
                                            €
                                        </span>
                                    </div>
                                    <div class="amount to_pay" t-if="not reminder_type">
                                        <span class="zz_label">Solde</span>
                                        <span class="amount">
                                            <t t-esc="'%.2f' %  (invoice.balance)"/>
                                            €
                                        </span>
                                    </div>
                                    <div class="amount to_pay">
                                        <b>
                                            <span>A payer avant le
                                                <t t-esc="invoice.payment_term"/>
                                            </span>
                                        </b>
                                    </div>
                                </div>
                            </div>

                            <div>
                                style="page-break-inside: avoid;display: block;width: 100%;padding: 0 0 0 0px;margin 0 0
                                0 0;">
                                <p>
                                    <t t-raw="invoice.activitycategoryid.invoice_comment"/>
                                </p>
                            </div>

                            <div id="invoice_comment">
                                <p>
                                    <t t-raw="'%s%s' % (invoice.biller_id.comment if invoice.biller_id.comment != False else '',invoice.comment if invoice.comment != False else '')"/>
                                </p>
                            </div>

                            <div id="payment_info">
                                <span>Compte :</span>
                                <t t-esc="invoice.activitycategoryid.bankaccount"/>
                                <br/>
                                <span>BIC :</span>
                                <t t-esc="invoice.activitycategoryid.bank_bic"/>
                                <br/>
                                <div class="com_struct">
                                    <span>Communication structurée :</span>
                                    <t t-esc="invoice.structcom"/>
                                </div>
                            </div>

                            <div id="doc_resp_sign">
                                <div>
                                    <span t-esc="invoice.activitycategoryid.organising_power_id.po_resp_name"/>
                                    <span t-esc="invoice.activitycategoryid.organising_power_id.po_resp_name"/>
                                </div>
                            </div>

                            <div id="invoice_body">
                                <h2>Détail des présences</h2>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ES</th>
                                            <th>Invoice ID</th>
                                            <th>Invoice line ID</th>
                                            <th>Activité</th>
                                            <th>Date</th>
                                            <th>Entrée</th>
                                            <th>Sortie</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <t t-set="saved_child_id" t-value="0"/>
                                    <t t-set="saved_activity" t-value="'******'"/>
                                    <t t-set="saved_description" t-value="'*****'"/>
                                    <t t-set="saved_activity_date" t-value="01-01-1977"/>
                                    <t t-set="activity_count" t-value="0"/>
                                    <t t-set="activity_amount" t-value="0"/>
                                    <t t-set="activity_time" t-value="0"/>
                                    <t t-set="activity_entry" t-value="'00:00'"/>
                                    <t t-set="activity_exit" t-value="'00:00'"/>
                                    <tbody>
                                        <span
                                            t-esc="len(invoice.invoice_line_ids.sorted(key=lambda r: r.prestation_date))"/>
                                        <t t-foreach="invoice.get_infos_childs_performance()" t-as="prestation_time">
                                            <t t-if="activity_count != 0">
                                                <tr>
                                                    <td>
                                                        <span t-esc="prestation_time[0].es"/>
                                                    </td>
                                                    <td>
                                                        <span t-esc="invoice.id"/>
                                                    </td>
                                                    <td>
                                                        <span t-esc="prestation_time[0].invoiced_prestation_id.id"/>
                                                    </td>

                                                    <td>
                                                        <span
                                                            t-esc="'%s - %s %s' % (saved_child_id.name if saved_child_id != False else '',saved_activity if saved_activity != False else '',saved_description if saved_description != False else '')"/>
                                                    </td>
                                                    <td>
                                                        <span t-esc="saved_activity_date_str"/>
                                                    </td>
                                                    <td>
                                                        <span t-esc="prestation_time[1]"/>
                                                    </td>
                                                    <td>
                                                        <span t-esc="prestation_time[2]"/>
                                                    </td>
                                                    <td class="amount">
                                                        <span t-esc="'%.2f €' %  (activity_amount)"/>
                                                    </td>
                                                </tr>
                                            </t>
                                            <t t-set="saved_child_id" t-value="prestation_time[0].childid"/>
                                            <t t-set="saved_activity"
                                               t-value="prestation_time[0].activity_occurrence_id.activityid.short_name"/>
                                            <t t-set="saved_description"
                                               t-value="prestation_time[0].invoiced_prestation_id.description"/>
                                            <t t-set="saved_activity_date" t-value="prestation_time[0].prestation_date"/>
                                            <t t-set="saved_activity_date_str"
                                               t-value="'%s' % (prestation_time[0].prestation_date)"/>
                                            <!--<t t-set="saved_activity_date_str" t-value="'%s' % (prestation_time[0].prestation_date.strftime('%d-%m-%Y'))"/>-->
                                            <t t-set="activity_count" t-value="0"/>
                                            <t t-set="activity_amount" t-value="0"/>
                                            <t t-set="activity_time" t-value="0"/>
                                            <!--                                                <t t-set="activity_entry" t-value="prestation_time[0].get_child_entry()"/>-->
                                            <!--                                                <t t-set="activity_exit" t-value="prestation_time[0].get_child_exit()"/>-->
                                            <!--                                                <t t-set="activity_entry"-->
                                            <!--                                                   t-value="prestation_time[0].get_child_entry_performance()"/>-->
                                            <!--                                                <t t-set="activity_exit"-->
                                            <!--                                                   t-value="prestation_time[0].get_child_exit_performance()"/>-->


                                            <t t-if="saved_activity == prestation_time[0].activity_occurrence_id.activityid.short_name">
                                                <t t-set="activity_count" t-value="activity_count + 1"/>
                                                <t t-set="activity_amount"
                                                   t-value="activity_amount + prestation_time[0].invoiced_prestation_id.total_price"/>
                                                <t t-set="activity_time"
                                                   t-value="activity_time + prestation_time[0].invoiced_prestation_id.duration"/>
                                            </t>
                                        </t>
                                        <t t-if="activity_count != 0">
                                            <t t-set="saved_activity_date_str" t-value="'%s' % (saved_activity_date)"/>
                                            <!--<t t-set="saved_activity_date_str" t-value="'%s' % (time.strftime('%d-%m-%Y',time.strptime(saved_activity_date,'%Y-%m-%d')))"/>-->
                                            <tr>
                                                <td>
                                                    <span
                                                        t-esc="'%s - %s %s' % (saved_child_id.name if saved_child_id != False else '',saved_activity if saved_activity != False else '',saved_description if saved_description != False else '')"/>
                                                </td>
                                                <td>
                                                    <span t-esc="saved_activity_date_str"/>
                                                </td>
                                                <td>
                                                    <span t-esc="activity_entry"/>
                                                </td>
                                                <td>
                                                    <span t-esc="activity_exit"/>
                                                </td>
                                                <td class="amount">
                                                    <span t-esc="'%.2f €' %  (activity_amount)"/>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>

                        </div>

                        <div class="footer">
                        </div>
                    </t>
                </div>
            </xpath>
        </template>

        <report
            id="extraschool_invoice_std_performance"
            model="extraschool.invoice"
            string="Invoice performance"
            report_type="qweb-pdf"
            name="extraschool.invoice_report_layout_performance"
            attachment_use="False"
        />
    </data>
</odoo>
