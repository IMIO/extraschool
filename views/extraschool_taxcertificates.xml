<?xml version="1.0" ?>
<odoo>
	<data>
       <record model="ir.ui.view" id="extraschool_taxcertificate_tree">
            <field name="name">extraschool.taxcertificate.tree</field>
            <field name="model">extraschool.taxcertificate</field>
            <field name="type">tree</field>
            <field name="arch" type="xml">
                <tree string="Tax Certificate">
                    <field name="title" />
                    <field name="name" />
                </tree>
            </field>
        </record>

		<record model="ir.ui.view" id="extraschool_taxcertificate_form">
            <field name="name">extraschool.taxcertificate.form</field>
            <field name="model">extraschool.taxcertificate</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form string="Tax Certificate">
					<header>
						<button name="generate_pdf" string="Création des PDF" type="object" class="oe_highlight" groups="base.group_erp_manager"/>
					</header>

                	<field name="pdf_ready" invisible="True" />
					<div class="oe_right oe_button_box" name="processin" attrs="{'invisible':[('pdf_ready', '=', True)]}">
						<h2>Création des PDF en cours .....</h2>
					</div>

					<div class="oe_right oe_button_box" name="buttons" attrs="{'invisible':[('pdf_ready', '=', False)]}">
                        <button name="mail_invoices" string="Attestation Courrier" type="object" class="oe_inline oe_stat_button" icon="fa-print"/>
						<button name="email_invoices" string="Attestation Email" type="object" class="oe_inline oe_stat_button" icon="fa-envelope-o"/>
						<button name="all_taxecertificate" string="Toutes les attestations" type="object" class="oe_inline oe_stat_button" icon="fa-files-o"/>
						<button name="all_pdf" string="Docs" type="object" class="oe_inline oe_stat_button" icon="fa-files-o" groups="base.group_erp_manager"/>
					</div>

                    <group col="4">
                        <field name="title" />
                        <field name="name" />
                        <field name="doc_date" />
                        <field name="organising_power_id" invisible="True"/>
                        <newline/>
                        <separator string="Taxe certificate" colspan="4"/>
                        <field name="taxcertificate_item_ids" colspan="4" nolabel="1" readonly="True"/>
                    </group>
                    <div class="oe_chatter" groups="extraschool.extraschool_gods">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>

        <record model="ir.ui.view" id="extraschool_taxcertificate_item_form">
            <field name="name">extraschool.taxcertificate_item.form</field>
            <field name="model">extraschool.taxcertificate_item</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form create="false" delete="false" string="Tax Certificate">
                    <sheet>
                        <group>
                            <group>
                                <field name="parent_id" />
                                <field name="implantation" />
                                <field name="nbr_day" />
                            </group>
                            <group>
                                <field name="child_id" />
                                <field name="niveau" />
                                <field name="amount" />
                                <field name="organising_power_id" invisible="True"/>
                            </group>
                        </group>
                    </sheet>
                </form>
            </field>
        </record>

       <record model="ir.ui.view" id="extraschool_taxcertificate_item_tree">
            <field name="name">extraschool.taxcertificate_item.tree</field>
            <field name="model">extraschool.taxcertificate_item</field>
            <field name="type">tree</field>
            <field name="arch" type="xml">
                <tree string="Tax Certificate" create="false">
                    <field name="name" />
                    <field name="parent_id" />
                    <field name="child_id" />
                    <field name="nbr_day" />
                    <field name="amount" />
                    <field name="annee" />
                </tree>
            </field>
        </record>

        <record model="ir.ui.view" id="extraschool_taxcertificate_item_form">
            <field name="name">extraschool.taxcertificate_item.form</field>
            <field name="model">extraschool.taxcertificate_item</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form string="Tax Certificate" create="false" edit="false">
                    <sheet>
                        <group col="4">
                            <field name="name" />
                            <field name="parent_id" />
                            <field name="child_id" />
                            <field name="nbr_day" />
                            <field name="prest_from" />
                            <field name="prest_to" />
                            <field name="amount" />
                        </group>
<!--                        <notebook>-->
<!--                            <page string="Detail">-->
<!--                                <field name="tax_certificate_detail_ids">-->
<!--                                    <tree string="Detail" editable="top">-->
<!--                                        <field name="child_name" sum="true"/>-->
<!--                                        <field name="invoice_number" />-->
<!--                                        <field name="activity_name" />-->
<!--                                        <field name="prestation_date" />-->
<!--                                        <field name="time_scan" />-->
<!--                                        <field name="entry_exit" />-->
<!--                                        <field name="amount"/>-->
<!--                                    </tree>-->
<!--                                </field>-->
<!--                            </page>-->
<!--                        </notebook>-->
                    </sheet>
                    <div class="oe_chatter" groups="extraschool.extraschool_gods">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>

        <record id="extraschool_taxcertificate_item_view_search" model="ir.ui.view">
            <field name="name">extraschool.taxcertificate_item.search</field>
            <field name="model">extraschool.taxcertificate_item</field>
            <field name="arch" type="xml">
                <search>
                    <field name="parent_id"/>
                    <group expand="0" string="Group by...">
                        <filter string='Implantation Scolaire' icon="terp-stock_symbol-selection" domain="[]" context="{'group_by' : 'implantation'}"/>
                       <filter string='Niveau' icon="terp-stock_symbol-selection" domain="[]" context="{'group_by' : 'niveau'}"/>
                       <filter string='Parent' icon="terp-stock_symbol-selection" domain="[]" context="{'group_by' : 'parent_id'}"/>
                    </group>
                </search>
            </field>
        </record>

        <record model="ir.actions.act_window" id="action_extraschool_taxcertificate">
            <field name="name">Tax Certificate</field>
            <field name="res_model">extraschool.taxcertificate</field>
            <field name="view_type">form</field>
        </record>

        <record model="ir.actions.act_window.view" id="action_extraschool_taxcertificate_item">
			<field name="name">Tax Certificate</field>
            <field eval="2" name="sequence"/>
			<field name="res_model">extraschool.taxcertificate_item</field>
            <field name="view_mode">form</field>
            <field name="view_id" ref="extraschool_taxcertificate_item_form" />
		</record>

       <record model="ir.ui.view" id="extraschool_taxcertificates_wizard_form">
            <field name="name">extraschool.taxcertificates.wizard.form</field>
            <field name="model">extraschool.taxcertificates_wizard</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form string="Tax Certificates Wizard">
                    <field name="state" invisible="1" />
                    <group states="init">
                        <field name="year" />
                        <field name="activitycategory" />
                        <field name="parentid" />
                    </group>
                    <group states="compute_taxcertificates">
                        <field name="name" invisible="1" colspan="4"/>
                        <field name="taxcertificates" nolabel="1" readonly="1" filename="name" colspan="4"/>
                        <label string="Ok" />
                    </group>
                    <separator string="" colspan="4"/>
                    <group colspan="4" col="3">
                        <button name="action_compute_taxcertificates" string="Compute taxcertificates" icon="gtk-apply" type="object"
                            states="init" />
                    </group>
                    <label string="" colspan="4" />
                    <label string="" colspan="4" />
                    <label string="" colspan="4" />
                </form>
            </field>
        </record>
        <record model="ir.actions.act_window" id="action_lbsc_taxcertificates_wizard">
            <field name="name">Tax Certificates Wizard</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">extraschool.taxcertificates_wizard</field>
            <field name="view_type">form</field>
            <field name="view_mode">form</field>
            <field name="target">inline</field>
        </record>
	</data>

    	<data noupdate="1">
        <!--Definition of an email template with an empty body that will be used in payment mailing. Used to give a
            basis for email recipients, name and to ease the definition of a further elaborated template. -->
        <record id="email_template_tax_certificate" model="mail.template">
            <field name="name">E-mail d'attestation fiscale</field>
            <field name="model_id" ref="model_extraschool_taxcertificate_item"/>
            <field name="auto_delete" eval="True"/>
            <field name="subject">Attestation fiscale</field>
            <field name="email_to">${(object.parent_id.email or '')|safe}</field>
            <field name="email_from">${(object.taxcertificate_id.activity_category_id.invoiceemailaddress or '')|safe}</field>
            <field name="reply_to">${(object.taxcertificate_id.activity_category_id.invoiceemailaddress or '')|safe}</field>
            <field name="mail_server_id" ref="base.ir_mail_server_localhost0"/>
<field name="body_html"><![CDATA[
<div style="font-family: 'Lucica Grande', Ubuntu, Arial, Verdana, sans-serif; font-size: 12px; color: rgb(34, 34, 34); background-color: #FFF; ">

    <p>Attention : Veuillez d'abord configurer avec IMIO votre modèle de mail avant d'envoyer les mails !! </p>

    <p>Bonjour ${object.parent_id.name},</p>

    <p>Vous trouverez en pièce jointe l'attestation fiscale</p>

</div>
            ]]></field>

        </record>
	</data>
	<data>
        <!--  Replace the default mass-mailing wizard in base with the composition wizard -->
        <act_window name="Tax Certificate mail"
                res_model="mail.compose.message"
                src_model="extraschool.taxcertificate_item"
                view_mode="form"
                multi="True"
                target="new"
                key2="client_action_multi"
                id="extraschool.taxcertificate_mass_mail"
                context="{
                            'default_composition_mode': 'mass_mail',
                            'default_partner_to': '${object.id or \'\'}',
                            'default_use_template': True,
                            'default_template_id': ref('email_template_tax_certificate'),
                        }"/>

        <record id="email_template_tax_certificate" model="mail.template">
            <field name="ref_ir_act_window" ref="extraschool.taxcertificate_mass_mail"/>
        </record>

	</data>
</odoo>
